version: 0.2
phases:
  install:
    runtime-versions:
      nodejs: 12
    commands:
      # GET INSIDE THE FOLDER
      - cd $(ls -d */|head -n 1)

      - npm config set unsafe-perm=true
      - npm install --silent --no-progress -g serverless@$SERVERLESS_VERSION
      - npm install --silent
      # COMMAND FOR ENTERING THE FOLDER THAT IS GENERATED BY BITBUCKET
  pre_build:
    commands:
      - |
        ${self:custom.serverless.prebuild}
  build: # only runs if pre-build succeeded
    commands:
      - mkdir -p ../$QA_TARGET_DIR
      - mkdir -p ../$PROD_TARGET_DIR

      - ${self:custom.serverless.packageProduction}
      - cp -R ${self:custom.serverless.packageOutputFolder}/. ../$PROD_TARGET_DIR/
      - rm -rf ${self:custom.serverless.packageOutputFolder}
      
      # ASSUMING QA ROLE IF ONE QA TO DO EVERYTHING ON BEHALF OF THAT USER
      - ${escapedFileToString:resources/buildspecs/assumeQARole.sh}
        
      - ${self:custom.serverless.packageQA}
      - cp -R ${self:custom.serverless.packageOutputFolder}/. ../$QA_TARGET_DIR/
      - rm -rf ${self:custom.serverless.packageOutputFolder}
cache:
  paths:
    - 'node_modules/**/*'

artifacts:
  secondary-artifacts:
    QAServerlessArtifact:
      name: QAServerlessArtifact
      base-directory: $QA_TARGET_DIR/
      files:
        - '**/*'
    ProductionServerlessArtifact:
      name: ProductionServerlessArtifact
      base-directory: $PROD_TARGET_DIR/
      files:
        - '**/*'